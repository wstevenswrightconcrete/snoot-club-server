<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Snoot Club — Admin</title>
<style>
  :root { --navy:#0B1B32; --silver:#C0C0C0; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--navy);color:var(--silver);margin:0}
  .wrap{max-width:1000px;margin:32px auto;padding:0 16px;text-align:center}
  .card{background:#132A4B;border-radius:16px;padding:18px;margin:16px auto;box-shadow:0 8px 24px rgba(0,0,0,.25);text-align:left}
  input,textarea,button{font:inherit}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #244;background:#0B1B32;color:var(--silver)}
  label{display:block;margin:10px 0 6px}
  button{background:var(--silver);color:var(--navy);border:0;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  table{width:100%;border-collapse:collapse}
  td,th{border-bottom:1px solid #244;padding:8px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{opacity:.8}
  .flex{display:flex;gap:8px;flex-wrap:wrap}
  .ok{color:#9ef59e}.err{color:#ff9b9b}

  /* Logo */
  .logo{display:block;width:140px;max-width:40vw;height:auto;margin:0 auto 8px;filter: drop-shadow(0 6px 18px rgba(0,0,0,.35));}
  .brand-title{margin:6px 0 16px;font-weight:800;letter-spacing:.4px}
</style>

<div class="wrap">
  <!-- LOGO -->
  <img class="logo" src="./logo.png" alt="Snoot Club logo" />
  <h1 class="brand-title">Snoot Club — Admin</h1>
  <p class="muted">Approve new members, promote to admin, and send meeting reminders to approved members only.</p>

  <div class="card">
    <label>Render Base URL</label>
    <input id="base" placeholder="https://snoot-club-server.onrender.com" />
    <label>Admin PIN</label>
    <input id="pin" placeholder="*****" />
    <div class="flex" style="margin-top:10px">
      <button id="btnAuth">Unlock Admin</button>
      <span id="authState" class="muted">Locked</span>
    </div>
  </div>

  <div class="card" id="pendingCard" style="display:none">
    <h2 style="margin-top:0">Pending Requests</h2>
    <table id="pending"><thead><tr><th>Phone</th><th>Requested</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card" id="approvedCard" style="display:none">
    <h2 style="margin-top:0">Approved Members</h2>
    <table id="approved"><thead><tr><th>Phone</th><th>Role</th><th>Actions</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card" id="meetingCard" style="display:none">
    <h2 style="margin-top:0">New Meeting</h2>
    <label>Title</label><input id="title" />
    <label>Description (optional)</label><textarea id="desc" rows="3"></textarea>
    <div class="row">
      <div><label>Location</label><input id="loc" value="Lodge" /></div>
      <div><label>Starts At (local)</label><input id="dt" type="datetime-local" /></div>
    </div>
    <label>Reminder Minutes</label><input id="rem" type="number" value="60" />
    <div class="flex" style="margin-top:10px">
      <button id="btnCreate">Create & Notify</button>
      <button id="btnRefresh">Refresh</button>
      <span id="createState" class="muted"></span>
    </div>
  </div>

  <div id="out" class="muted"></div>
</div>

<script>
const $ = (id) => document.getElementById(id);
const show = (el, v=true)=>el.style.display = v ? '' : 'none';
const out = (msg, cls='') => { const el=$('out'); el.textContent = typeof msg==='string'?msg:JSON.stringify(msg,null,2); el.className=cls; };
let authed = false;

function base(){ return $('base').value.trim().replace(/\/+$/,''); }
async function api(path, method='GET', body){
  const url = base() + path;
  const opts = { method, headers:{ 'content-type':'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  const text = await res.text();
  try { return JSON.parse(text); } catch { return text; }
}

$('btnAuth').onclick = async ()=>{
  try{
    const res = await api('/auth/admin','POST',{ phone: 'DUMMY', pin: $('pin').value.trim() }); // unlock UI after PIN entry
    if ((res && res.ok) || $('pin').value.trim()) {
      authed=true; out('Admin unlocked','ok'); show($('pendingCard'),1); show($('approvedCard'),1); show($('meetingCard'),1); loadLists();
    } else out('Wrong PIN','err');
  }catch(e){ out('Error: '+e.message,'err'); }
};

$('btnRefresh').onclick = ()=>loadLists();

async function loadLists(){
  try{
    // pending
    const pending = await api('/members?status=pending');
    const pbody = $('pending').querySelector('tbody'); pbody.innerHTML='';
    (pending||[]).sort((a,b)=>a.createdAt-b.createdAt).forEach(m=>{
      const tr = document.createElement('tr');
      const when = m.createdAt ? new Date(m.createdAt).toLocaleString() : '';
      tr.innerHTML = `<td>${m.phone}</td><td>${when}</td>
        <td class="flex">
          <button data-a="${m.id}">Approve</button>
          <button data-r="${m.id}">Reject</button>
        </td>`;
      tr.querySelector('[data-a]').onclick = async ()=>{ await api('/members/'+m.id+'/approve','POST',{}); loadLists(); };
      tr.querySelector('[data-r]').onclick = async ()=>{ await api('/members/'+m.id+'/reject','POST',{}); loadLists(); };
      pbody.appendChild(tr);
    });

    // approved
    const approved = await api('/members?status=approved');
    const abody = $('approved').querySelector('tbody'); abody.innerHTML='';
    (approved||[]).forEach(m=>{
      const tr = document.createElement('tr');
      const role = m.isAdmin ? 'Admin' : 'Member';
      tr.innerHTML = `<td>${m.phone}</td><td>${role}</td>
        <td class="flex">
          ${m.isAdmin
            ? `<button data-rm="${m.id}">Remove Admin</button>`
            : `<button data-mk="${m.id}">Make Admin</button>`}
          <button data-del="${m.id}">Remove</button>
        </td>`;
      if (m.isAdmin) tr.querySelector('[data-rm]').onclick = async ()=>{ await api('/members/'+m.id+'/remove-admin','POST',{}); loadLists(); };
      else tr.querySelector('[data-mk]').onclick = async ()=>{ await api('/members/'+m.id+'/make-admin','POST',{}); loadLists(); };
      tr.querySelector('[data-del]').onclick = async ()=>{ await api('/members/'+m.id,'DELETE'); loadLists(); };
      abody.appendChild(tr);
    });
  }catch(e){ out('Load error: '+e.message,'err'); }
}

$('btnCreate').onclick = async ()=>{
  if(!authed) return out('Unlock admin first','err');
  try{
    $('createState').textContent='Sending...';
    const local = $('dt').value;
    const iso = local ? new Date(local).toISOString() : new Date().toISOString();
    const payload = {
      title: $('title').value.trim(),
      description: $('desc').value.trim(),
      location: $('loc').value.trim(),
      startsAt: iso,
      reminderMinutes: parseInt($('rem').value || '60', 10),
      sendSms: true,
      sendPush: true
    };
    const res = await api('/meetings','POST', payload);
    $('createState').textContent='Sent';
    out(res,'ok');
  }catch(e){ $('createState').textContent='Error'; out('Error: '+e.message,'err'); }
};
</script>

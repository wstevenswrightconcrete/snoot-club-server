<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Snoot Club ‚Äî Admin</title>
  <link rel="icon" href="./logo.png">
  <style>
    :root{
      --brand:#0e5a8a;        /* dark teal from logo */
      --brand-2:#2aa2d6;      /* light teal/blue from logo */
      --bg:#f6fbff;
      --text:#0f172a;
      --muted:#64748b;
      --card:#ffffff;
      --danger:#dc2626;
      --ok:#16a34a;
      --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font:16px/1.4 system-ui,Segoe UI,Roboto,Arial;
      color:var(--text); background:var(--bg);
    }
    header{
      display:flex; align-items:center; gap:14px;
      padding:18px 20px; background: #0d223a;
      color:#fff;
    }
    header img{height:120px}
    header h1{font-size:18px; margin:0; font-weight:600}
    main{max-width:1100px; margin:24px auto; padding:0 16px}
    .card{
      background:var(--card); border:1px solid #e2e8f0; border-radius:var(--radius);
      padding:16px; box-shadow:0 4px 16px rgba(2,6,23,.06); margin-bottom:16px;
    }
    .row{display:flex; flex-wrap:wrap; gap:16px}
    .col{flex:1 1 320px}
    button,input,select,textarea{ font:inherit; }
    input,select,textarea{
      width:100%; padding:10px 12px; border:1px solid #cbd5e1; border-radius:12px; background:#fff;
    }
    button.btn{
      border:0; padding:10px 14px; border-radius:12px; cursor:pointer; color:#fff; background:var(--brand);
    }
    .btn.alt{background:var(--brand-2)}
    .btn.danger{background:var(--danger)}
    .btn.muted{background:#334155}
    .btn.warn{background:var(--warn)}
    .right{margin-left:auto}
    .hidden{display:none !important}
    .list{display:grid; gap:8px}
    .item{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid #e2e8f0; border-radius:12px; background:#fff;
    }
    .item .name{font-weight:600}
    .item .sub{color:var(--muted); font-size:13px}
    .pill{font-size:12px; padding:2px 8px; border-radius:999px; background:#e2e8f0}
    .section-title{display:flex; align-items:center; gap:8px; margin:6px 0 10px}
    .section-title h2{margin:0; font-size:16px}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
    .danger-text{color:var(--danger)}
    .note{font-size:13px; color:var(--muted)}
    .topbar{display:flex; gap:8px; align-items:center; margin-bottom:10px}
  </style>
</head>
<body>
<header>
  <img src="./logo.png" alt="Logo">
  <h1>Snoot Club ‚Äî Admin Console</h1>
  <div class="right">
    <button id="logoutBtn" class="btn muted hidden" type="button">Log out (admin)</button>
  </div>
</header>

<main>
  <!-- LOGIN CARD -->
  <section id="loginCard" class="card">
    <div class="section-title"><h2>Admin Login (PIN)</h2></div>
    <div class="row">
      <div class="col" style="max-width:360px">
        <label for="pin">Enter admin PIN</label>
        <input id="pin" type="password" inputmode="numeric" autocomplete="one-time-code" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <div class="topbar">
          <button class="btn" id="unlockBtn" type="button">Unlock</button>
          <span id="loginMsg" class="note"></span>
        </div>
        <p class="note">This admin view is PIN-only. Member email/password is separate and lives in the app UI.</p>
      </div>
    </div>
  </section>

  <!-- DASHBOARD -->
  <section id="dash" class="hidden">
    <div class="row">
      <!-- MEMBERS -->
      <div class="col">
        <div class="card">
          <div class="section-title">
            <h2>Members</h2>
            <span id="counts" class="pill">‚Äî</span>
          </div>
          <div class="toolbar">
            <button class="btn alt" type="button" data-filter="pending">Pending</button>
            <button class="btn" type="button" data-filter="approved">Approved</button>
            <button class="btn muted" type="button" data-filter="rejected">Rejected</button>
            <span class="note">Tip: Approve people to let them log in & chat.</span>
          </div>
          <div id="memberList" class="list" style="margin-top:10px"></div>
        </div>
      </div>

      <!-- MEETINGS -->
      <div class="col">
        <div class="card">
          <div class="section-title"><h2>Create Meeting</h2></div>
          <div class="row">
            <div class="col">
              <label>Title</label>
              <input id="mtTitle" placeholder="Monthly Meetup">
            </div>
          </div>
          <div class="row">
            <div class="col"><label>Location</label><input id="mtLoc" placeholder="Clubhouse"></div>
            <div class="col"><label>Starts At</label><input id="mtWhen" type="datetime-local"></div>
          </div>
          <div class="row">
            <div class="col"><label>Description</label><textarea id="mtDesc" rows="3" placeholder="Agenda, notes‚Ä¶"></textarea></div>
          </div>
          <div class="topbar">
            <button id="createMeetingBtn" class="btn" type="button">Create</button>
            <span id="meetingMsg" class="note"></span>
          </div>
        </div>

        <div class="card">
          <div class="section-title"><h2>Upcoming Meetings</h2></div>
          <div id="meetingList" class="list"></div>
        </div>

        <!-- CHAT -->
        <div class="card">
          <div class="section-title">
            <h2>Club Chat</h2>
            <span id="chatStatus" class="pill">‚Äî</span>
          </div>
          <div id="chatList" class="list" style="max-height:320px; overflow:auto"></div>
          <div class="row" style="margin-top:10px">
            <div class="col"><input id="chatInput" placeholder="Type a message‚Ä¶"></div>
            <div><button id="chatSend" class="btn" type="button">Send</button></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  const $ = sel => document.querySelector(sel);
  const admin = {
    get pin(){ return sessionStorage.getItem('adminPin') || ''; },
    set pin(v){ v ? sessionStorage.setItem('adminPin', v) : sessionStorage.removeItem('adminPin'); }
  };

  const loginCard = $('#loginCard');
  const dash = $('#dash');
  const logoutBtn = $('#logoutBtn');

  function showLogin(){ loginCard.classList.remove('hidden'); dash.classList.add('hidden'); logoutBtn.classList.add('hidden'); }
  function showDash(){ loginCard.classList.add('hidden'); dash.classList.remove('hidden'); logoutBtn.classList.remove('hidden'); }

  async function unlock(pin){
    $('#loginMsg').textContent = 'Checking‚Ä¶';
    const r = await fetch('/auth/admin', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ pin })
    }).then(r=>r.json()).catch(()=>({ok:false}));
    if(r.ok){
      admin.pin = pin;
      $('#loginMsg').textContent = 'Unlocked.';
      showDash();
      await refreshAll();
      await loadChat();
      startChatPolling();
    }else{
      $('#loginMsg').textContent = 'Bad PIN.';
      admin.pin = '';
      showLogin();
    }
  }

  async function api(path, opts={}){
    const headers = Object.assign({'X-Admin-Pin': admin.pin}, opts.headers||{});
    const res = await fetch(path, Object.assign({}, opts, { headers }));
    if(!res.ok){
      let msg = '';
      try{ const j = await res.json(); msg = j.error || res.statusText; }catch{}
      throw new Error(msg || 'Request failed');
    }
    const ct = res.headers.get('content-type') || '';
    return ct.includes('application/json') ? res.json() : res.text();
  }

  // Members
  let currentFilter = 'pending';
  async function loadCounts(){
    const [pending, approved, rejected] = await Promise.all([
      api('/members?status=pending'),
      api('/members?status=approved'),
      api('/members?status=rejected'),
    ]);
    $('#counts').textContent = `pending ${pending.length} ‚Ä¢ approved ${approved.length} ‚Ä¢ rejected ${rejected.length}`;
  }
  function memberRow(m){
    const wrap = document.createElement('div');
    wrap.className = 'item';
    wrap.innerHTML = `
      <div style="flex:1">
        <div class="name">${m.name || m.phone || 'Member'}</div>
        <div class="sub">${m.email || ''} ${m.phone ? ' ‚Ä¢ ' + m.phone : ''} ${m.isAdmin ? ' ‚Ä¢ üõ°Ô∏è admin' : ''}</div>
      </div>
      <div class="toolbar">
        ${m.status!=='approved' ? `<button class="btn ok" data-act="approve">Approve</button>` : ''}
        ${m.status!=='rejected' ? `<button class="btn warn" data-act="reject">Reject</button>` : ''}
        ${m.isAdmin ? `<button class="btn muted" data-act="remove-admin">Remove admin</button>` : `<button class="btn alt" data-act="make-admin">Make admin</button>`}
        <button class="btn danger" data-act="delete">Delete</button>
      </div>
    `.replace('btn ok','btn');
    wrap.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const act = b.dataset.act;
        try{
          if(act==='approve') await api(`/members/${m.id}/approve`, {method:'POST'});
          if(act==='reject') await api(`/members/${m.id}/reject`, {method:'POST'});
          if(act==='make-admin') await api(`/members/${m.id}/make-admin`, {method:'POST'});
          if(act==='remove-admin') await api(`/members/${m.id}/remove-admin`, {method:'POST'});
          if(act==='delete') await api(`/members/${m.id}`, {method:'DELETE'});
          await renderMembers();
          await loadCounts();
        }catch(e){ alert('Error: '+e.message); }
      });
    });
    return wrap;
  }
  async function renderMembers(){
    const data = await api(`/members?status=${encodeURIComponent(currentFilter)}`);
    const list = $('#memberList'); list.innerHTML='';
    data.forEach(m => list.appendChild(memberRow(m)));
  }

  // Meetings
  function meetingRow(meet){
    const d = document.createElement('div');
    const when = new Date(meet.startsAt).toLocaleString();
    d.className='item';
    d.innerHTML = `
      <div style="flex:1">
        <div class="name">${meet.title}</div>
        <div class="sub">${when} ‚Ä¢ ${meet.location || 'TBA'}</div>
      </div>
    `;
    return d;
  }
  async function renderMeetings(){
    const data = await api('/meetings');
    const list = $('#meetingList'); list.innerHTML='';
    data.forEach(m => list.appendChild(meetingRow(m)));
  }

  async function createMeeting(){
    const title = $('#mtTitle').value.trim();
    const location = $('#mtLoc').value.trim();
    const startsAt = $('#mtWhen').value;
    const description = $('#mtDesc').value.trim();
    if(!title || !startsAt){ $('#meetingMsg').textContent='Title and time required.'; return; }
    $('#meetingMsg').textContent='Creating‚Ä¶';
    try{
      await api('/meetings', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ title, location, description, startsAt })
      });
      $('#meetingMsg').textContent='Created.';
      $('#mtTitle').value=''; $('#mtLoc').value=''; $('#mtWhen').value=''; $('#mtDesc').value='';
      await renderMeetings();
    }catch(e){ $('#meetingMsg').textContent = 'Error: '+e.message; }
  }

  async function refreshAll(){
    await loadCounts();
    await renderMembers();
    await renderMeetings();
  }

  // ----- Chat (admin via REST) -----
  const chatList   = document.querySelector('#chatList');
  const chatInput  = document.querySelector('#chatInput');
  const chatStatus = document.querySelector('#chatStatus');

  function renderMsg(m){
    const d = document.createElement('div');
    d.className = 'item';
    const time = new Date(m.ts).toLocaleTimeString();
    d.innerHTML = `
      <div style="flex:1">
        <div class="name">${m.name} <span class="sub">‚Ä¢ ${time}</span></div>
        <div>${m.text}</div>
      </div>
    `;
    return d;
  }

  async function loadChat(){
    if(!chatList) return;
    try{
      const data = await api('/chat/messages');
      chatList.innerHTML = '';
      data.forEach(m => chatList.appendChild(renderMsg(m)));
      chatList.scrollTop = chatList.scrollHeight;
      chatStatus.textContent = `${data.length} messages`;
    }catch(e){
      chatStatus.textContent = 'error loading';
    }
  }

  async function sendChat(){
    const text = (chatInput?.value || '').trim();
    if(!text) return;
    try{
      await api('/chat/send', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ text })
      });
      chatInput.value = '';
      await loadChat();
    }catch(e){
      alert('Send failed: ' + e.message);
    }
  }

  document.querySelector('#chatSend')?.addEventListener('click', sendChat);
  chatInput?.addEventListener('keydown', e => { if(e.key === 'Enter') sendChat(); });

  let chatPoll;
  function startChatPolling(){
    clearInterval(chatPoll);
    chatPoll = setInterval(loadChat, 5000);
  }
  function stopChatPolling(){
    clearInterval(chatPoll);
  }

  // Wire up UI
  $('#unlockBtn').addEventListener('click', ()=> unlock(($('#pin').value||'').trim()));
  $('#pin').addEventListener('keydown', e=>{ if(e.key==='Enter') $('#unlockBtn').click(); });
  $('#createMeetingBtn').addEventListener('click', createMeeting);
  logoutBtn.addEventListener('click', ()=>{
    stopChatPolling();
    admin.pin = '';
    showLogin();
    $('#loginMsg').textContent = 'Logged out.';
  });
  document.querySelectorAll('[data-filter]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      currentFilter = btn.dataset.filter;
      await renderMembers();
    });
  });

  // Auto-try stored PIN
  (async function boot(){
    if(admin.pin){
      try{ await unlock(admin.pin); }catch{ showLogin(); }
    }else{
      showLogin();
    }
  })();
</script>
</body>
</html>

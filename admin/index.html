<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Snoot Club Admin</title>
  <style>
    :root { color-scheme: light dark; --bg:#0b0b0b; --fg:#ddd; --muted:#888; --ok:#18a558; --err:#d33; --card:#1b1b1b; --line:#2a2a2a; }
    *{box-sizing:border-box} body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center}
    header h1{margin:0;font-size:16px;font-weight:600}
    main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button,select,textarea{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#111;color:var(--fg);outline:none}
    input:disabled,button:disabled{opacity:.6}
    button{cursor:pointer}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{display:flex;justify-content:space-between;gap:10px;padding:10px;border:1px solid var(--line);border-radius:10px;background:#141414}
    .grow{flex:1}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .right{margin-left:auto}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){ .grid2{grid-template-columns:1fr 1fr}}
    .hidden{display:none}
  </style>
</head>
<body>
  <header>
    <h1>üîê Snoot Club Admin</h1>
    <span id="status" class="muted">locked</span>
    <span class="right"></span>
    <button id="btnLogout" class="hidden">Lock</button>
  </header>

  <main>
    <!-- Login -->
    <section id="loginCard" class="card">
      <div class="row">
        <label for="pin">Admin PIN</label>
        <input id="pin" type="password" inputmode="numeric" placeholder="Enter PIN" />
        <button id="btnUnlock">Unlock</button>
        <span id="loginMsg" class="muted"></span>
      </div>
      <p class="muted" style="margin-top:8px">PIN is checked by the server and never stored permanently (kept in memory only for this tab until you click ‚ÄúLock‚Äù).</p>
    </section>

    <!-- App -->
    <section id="app" class="grid2 hidden">
      <!-- Members -->
      <div class="card">
        <h3 style="margin-top:0">Members</h3>
        <div class="row">
          <button id="btnLoadPending">Load Pending</button>
          <button id="btnLoadAll">Load All</button>
          <span id="membersMsg" class="muted"></span>
        </div>
        <div id="membersList" class="list"></div>
      </div>

      <!-- Create meeting -->
      <div class="card">
        <h3 style="margin-top:0">Create Meeting</h3>
        <div class="row">
          <input id="mtTitle" placeholder="Title" class="grow" />
        </div>
        <div class="row">
          <input id="mtLocation" placeholder="Location" class="grow" />
        </div>
        <div class="row">
          <textarea id="mtDesc" placeholder="Description" rows="4" class="grow"></textarea>
        </div>
        <div class="row">
          <label>Starts</label>
          <input id="mtStart" type="datetime-local" />
          <label>Reminder (min)</label>
          <input id="mtRem" type="number" min="5" step="5" value="60" style="width:100px" />
        </div>
        <div class="row">
          <label class="row"><input type="checkbox" id="mtSms" checked />&nbsp;SMS on create</label>
          <label class="row"><input type="checkbox" id="mtPush" checked />&nbsp;Push on create</label>
          <button id="btnCreate">Create</button>
          <span id="createMsg" class="muted"></span>
        </div>
      </div>

      <!-- Meetings list (optional quick view) -->
      <div class="card" style="grid-column:1/-1">
        <div class="row">
          <h3 style="margin:0">Meetings</h3>
          <button id="btnLoadMeetings" class="right">Refresh</button>
        </div>
        <div id="meetingsList" class="list"></div>
      </div>
    </section>
  </main>

<script>
(() => {
  const API = location.origin;

  const els = {
    status:      document.getElementById('status'),
    loginCard:   document.getElementById('loginCard'),
    pin:         document.getElementById('pin'),
    btnUnlock:   document.getElementById('btnUnlock'),
    btnLogout:   document.getElementById('btnLogout'),
    loginMsg:    document.getElementById('loginMsg'),
    app:         document.getElementById('app'),
    btnLoadPending: document.getElementById('btnLoadPending'),
    btnLoadAll:  document.getElementById('btnLoadAll'),
    membersMsg:  document.getElementById('membersMsg'),
    membersList: document.getElementById('membersList'),
    mtTitle:     document.getElementById('mtTitle'),
    mtLocation:  document.getElementById('mtLocation'),
    mtDesc:      document.getElementById('mtDesc'),
    mtStart:     document.getElementById('mtStart'),
    mtRem:       document.getElementById('mtRem'),
    mtSms:       document.getElementById('mtSms'),
    mtPush:      document.getElementById('mtPush'),
    btnCreate:   document.getElementById('btnCreate'),
    createMsg:   document.getElementById('createMsg'),
    btnLoadMeetings: document.getElementById('btnLoadMeetings'),
    meetingsList: document.getElementById('meetingsList'),
  };

  const getPin = () => sessionStorage.getItem('adminPin') || '';
  const setPin = (pin) => pin ? sessionStorage.setItem('adminPin', pin) : sessionStorage.removeItem('adminPin');

  async function postJSON(path, body) {
    const r = await fetch(API + path, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body || {})
    });
    return r.json().catch(() => ({}));
  }

  async function adminFetch(method, path, body) {
    const pin = getPin();
    const r = await fetch(API + path + (method === 'GET' && body ? '?' + new URLSearchParams(body) : ''), {
      method,
      headers: { 'Content-Type': 'application/json', 'x-admin-pin': pin },
      body: method === 'GET' ? undefined : JSON.stringify(body || {})
    });
    const data = await r.json().catch(() => ({}));
    if (r.status === 401) throw new Error('unauthorized');
    return data;
  }

  function setLockedUI(locked) {
    els.status.textContent = locked ? 'locked' : 'unlocked';
    els.loginCard.classList.toggle('hidden', !locked);
    els.app.classList.toggle('hidden', locked);
    els.btnLogout.classList.toggle('hidden', locked);
    if (locked) { els.pin.value = ''; els.pin.focus(); }
  }

  async function tryUnlock(pin) {
    els.btnUnlock.disabled = true;
    els.pin.disabled = true;
    els.loginMsg.textContent = 'Checking‚Ä¶';
    try {
      const res = await postJSON('/auth/admin', { pin });
      if (res && res.ok === true) {
        setPin(pin);
        setLockedUI(false);
        els.loginMsg.textContent = '';
        await loadPending();
        await loadMeetings();
      } else {
        els.loginMsg.textContent = 'Wrong PIN';
        els.loginMsg.className = 'err';
      }
    } catch (e) {
      els.loginMsg.textContent = 'Network error';
      els.loginMsg.className = 'err';
    } finally {
      els.btnUnlock.disabled = false;
      els.pin.disabled = false;
    }
  }

  async function loadPending() {
    els.membersMsg.textContent = 'Loading pending‚Ä¶';
    try {
      const list = await adminFetch('GET', '/members', { status: 'pending' });
      renderMembers(list);
      els.membersMsg.textContent = `${list.length} pending`;
    } catch (e) {
      onUnauthorized(e);
    }
  }

  async function loadAll() {
    els.membersMsg.textContent = 'Loading all‚Ä¶';
    try {
      const list = await adminFetch('GET', '/members');
      renderMembers(list);
      els.membersMsg.textContent = `${list.length} total`;
    } catch (e) {
      onUnauthorized(e);
    }
  }

  function renderMembers(arr) {
    els.membersList.innerHTML = '';
    (arr || []).forEach(m => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="grow">
          <div><strong>${escapeHtml(m.name || m.phone || 'Member')}</strong></div>
          <div class="muted">${m.phone || ''} ${m.email ? ' ¬∑ ' + m.email : ''}</div>
          <div class="pill">${m.status}${m.isAdmin ? ' ¬∑ admin' : ''}</div>
        </div>
        <div class="row">
          ${m.status !== 'approved' ? `<button data-act="approve">Approve</button>` : ''}
          ${m.status !== 'rejected' ? `<button data-act="reject">Reject</button>` : ''}
          ${!m.isAdmin ? `<button data-act="makeAdmin">Make Admin</button>` : `<button data-act="removeAdmin">Remove Admin</button>`}
          <button data-act="delete" style="border-color:#552">Delete</button>
        </div>
      `;
      div.addEventListener('click', async (ev) => {
        const b = ev.target.closest('button'); if (!b) return;
        const act = b.getAttribute('data-act');
        try {
          if (act === 'approve') await adminFetch('POST', `/members/${m.id}/approve`);
          if (act === 'reject') await adminFetch('POST', `/members/${m.id}/reject`);
          if (act === 'makeAdmin') await adminFetch('POST', `/members/${m.id}/make-admin`);
          if (act === 'removeAdmin') await adminFetch('POST', `/members/${m.id}/remove-admin`);
          if (act === 'delete') await adminFetch('DELETE', `/members/${m.id}`);
          await loadPending();
        } catch (e) { onUnauthorized(e); }
      });
      els.membersList.appendChild(div);
    });
  }

  async function createMeeting() {
    els.createMsg.textContent = 'Creating‚Ä¶';
    els.btnCreate.disabled = true;
    try {
      const startsAt = toIso(els.mtStart.value);
      const body = {
        title: els.mtTitle.value.trim(),
        description: els.mtDesc.value.trim(),
        location: els.mtLocation.value.trim(),
        startsAt,
        reminderMinutes: Number(els.mtRem.value || 60),
        sendSms: !!els.mtSms.checked,
        sendPush: !!els.mtPush.checked
      };
      const res = await adminFetch('POST', '/meetings', body);
      if (res && res.id) {
        els.createMsg.textContent = '‚úÖ Created';
        els.createMsg.className = 'ok';
        await loadMeetings();
      } else {
        els.createMsg.textContent = 'Failed';
        els.createMsg.className = 'err';
      }
    } catch (e) { onUnauthorized(e); }
    finally { els.btnCreate.disabled = false; }
  }

  async function loadMeetings() {
    // uses member-protected route; just show count for admin sanity via PIN header is not needed here
    try {
      // We can‚Äôt call /meetings without a member token; so just show nothing here.
      // (Keeping this section minimal. Admin can still create meetings above.)
      els.meetingsList.innerHTML = `<div class="muted">Note: /meetings is member-protected; this panel only confirms create status.</div>`;
    } catch {}
  }

  function onUnauthorized(e) {
    if (String(e && e.message) === 'unauthorized') {
      setPin('');
      setLockedUI(true);
      els.loginMsg.textContent = 'Session locked. Enter PIN again.';
      els.loginMsg.className = 'muted';
    }
  }

  // Utilities
  function toIso(local) {
    // local is "YYYY-MM-DDTHH:MM"
    if (!local) return '';
    const d = new Date(local);
    // preserve local value as-is; browsers may treat as local time
    return new Date(
      d.getFullYear(), d.getMonth(), d.getDate(),
      d.getHours(), d.getMinutes(), 0, 0
    ).toISOString();
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

  // Wire up
  els.btnUnlock.addEventListener('click', () => {
    const pin = els.pin.value.trim();
    if (pin) tryUnlock(pin);
  });
  els.pin.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') els.btnUnlock.click();
  });
  els.btnLogout.addEventListener('click', () => {
    setPin('');
    setLockedUI(true);
  });
  els.btnLoadPending.addEventListener('click', loadPending);
  els.btnLoadAll.addEventListener('click', loadAll);
  els.btnCreate.addEventListener('click', createMeeting);
  els.btnLoadMeetings.addEventListener('click', loadMeetings);

  // Auto-try saved PIN (session only, not persistent)
  (async () => {
    const pin = getPin();
    if (pin) {
      try {
        const res = await postJSON('/auth/admin', { pin });
        if (res && res.ok) {
          setLockedUI(false);
          await loadPending();
          return;
        } else {
          setPin('');
        }
      } catch {}
    }
    setLockedUI(true);
  })();
})();
</script>
</body>
</html>

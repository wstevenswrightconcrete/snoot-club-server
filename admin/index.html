<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Snoot Club — Member</title>
<style>
  :root{--primary:#0B5778;--accent:#76B82A;--ink:#0a0a0a;--muted:#6b7280;--bg:#f6f8fb;--card:#fff;--radius:14px}
  *{box-sizing:border-box} html,body{margin:0;background:#0d223a;color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:940px;margin:28px auto;padding:0 16px}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{height:38px} .brand h1{font-size:20px;margin:0;color:var(--primary)}
  .card{background:var(--card);border:1px solid #e6ebf0;border-radius:var(--radius);padding:16px;box-shadow:0 1px 1px rgba(0,0,0,.02);margin-top:16px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input{width:100%;padding:12px;border:1px solid #d8dee6;border-radius:10px}
  input:focus{outline:none;box-shadow:0 0 0 3px rgba(11,87,120,.15);border-color:#b8d6e4}
  button{border:0;border-radius:10px;padding:10px 14px;font-weight:600;background:var(--primary);color:#fff;cursor:pointer}
  button.secondary{background:#eef5f8;color:var(--primary)}
  .row{display:flex;gap:16px;flex-wrap:wrap} .col{flex:1 1 280px}
  table{width:100%;border-collapse:collapse;margin-top:8px} th,td{padding:10px;border-bottom:1px solid #eef2f6;text-align:left}
  .muted{color:var(--muted)} .spacer{flex:1}
  [data-hidden]{display:none !important}
  /* chat */
  .chat-thread{height:360px;overflow:auto;border:1px solid #e6ebf0;border-radius:12px;background:#f9fafb;padding:12px}
  .msg{max-width:72%;margin:6px 0;padding:10px 12px;border-radius:12px;box-shadow:0 1px 1px rgba(0,0,0,.03)}
  .msg small{display:block;margin-top:6px;opacity:.8}
  .msg.me{background:var(--primary);color:#fff;margin-left:auto;border-bottom-right-radius:4px}
  .msg.other{background:#fff;border:1px solid #e6ebf0;border-bottom-left-radius:4px}
  .chat-send{display:flex;gap:10px;margin-top:10px} .chat-send input{flex:1}
</style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <img src="../admin/logo.png" alt="Snoot Club"/>
      <h1>Snoot Club</h1>
      <span class="spacer"></span>
      <button id="btnLogout" class="secondary" data-hidden>Log out</button>
    </div>

    <!-- Login -->
    <div id="loginCard" class="card">
      <h2>Sign in</h2>
      <div class="row">
        <div class="col">
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com"/>
        </div>
        <div class="col">
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••"/>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center">
        <button id="btnLogin">Sign in</button>
        <span id="loginMsg" class="muted"></span>
      </div>
      <p class="muted" style="margin-top:10px">Don’t have an account? Ask an admin to create one for you, or sign up in the app and wait for approval.</p>
    </div>

    <!-- Dashboard -->
    <div id="dash" data-hidden>
      <!-- Meetings -->
      <div class="card">
        <h2>Upcoming meetings</h2>
        <table id="mtgTable">
          <thead><tr><th>Title</th><th>Starts</th><th>Location</th><th>Description</th></tr></thead>
          <tbody id="mtgBody"><tr><td class="muted" colspan="4">Loading…</td></tr></tbody>
        </table>
      </div>

      <!-- Chat -->
      <div class="card">
        <h2>All Members chat</h2>
        <div id="chatThread" class="chat-thread" aria-live="polite"></div>
        <div class="chat-send">
          <input id="chatInput" placeholder="Say something to everyone…"/>
          <button id="btnSend">Send</button>
        </div>
        <div id="chatMsg" class="muted" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

<script>
  const API_BASE = ''; // same origin; if API lives elsewhere, put full origin here.
  const $ = (q, el=document)=>el.querySelector(q);
  const state = { token:null, member:null, cursor:null, poll:null };

  function setView(){
    const authed = !!state.token;
    $('#loginCard')?.toggleAttribute('data-hidden', authed);
    $('#dash')?.toggleAttribute('data-hidden', !authed);
    $('#btnLogout')?.toggleAttribute('data-hidden', !authed);
  }

  async function api(path, {method='GET', body, token}={}){
    const res = await fetch(API_BASE + path, {
      method,
      headers: {
        'content-type':'application/json',
        ...(token? {'authorization':'Bearer '+token} : {})
      },
      body: body ? JSON.stringify(body) : undefined
    });
    let data=null; try{ data=await res.json(); }catch{}
    if(!res.ok) throw new Error(data?.error || res.statusText);
    return data ?? {};
  }

  async function login(){
    $('#loginMsg').textContent = '';
    const email = $('#email').value.trim();
    const password = $('#password').value.trim();
    if(!email || !password){ $('#loginMsg').textContent='Enter email and password.'; return; }
    try{
      const r = await api('/auth/login-email', {method:'POST', body:{email,password}});
      state.token = r.token; state.member = r.member;
      setView();
      loadMeetings();
      startChat();
    }catch(e){
      $('#loginMsg').textContent = e.message || 'Login failed';
    }
  }

  async function loadMeetings(){
    try{
      const r = await api('/meetings', {token:state.token});
      const tb = $('#mtgBody');
      const list = r.meetings || [];
      if(!list.length){ tb.innerHTML = '<tr><td class="muted" colspan="4">No meetings yet.</td></tr>'; return; }
      tb.innerHTML = list.map(m=>`
        <tr>
          <td>${escape(m.title||'')}</td>
          <td>${escape(new Date(m.startsAt).toLocaleString())}</td>
          <td>${escape(m.location||'')}</td>
          <td>${escape(m.description||'')}</td>
        </tr>`).join('');
    }catch{ $('#mtgBody').innerHTML = '<tr><td class="muted" colspan="4">Could not load meetings.</td></tr>'; }
  }

  function escape(s){ const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; }

  function renderMsg(m){
    const mine = (m.fromId === state.member?.id) || (m.role==='admin' && state.member?.isAdmin);
    const div = document.createElement('div');
    div.className = 'msg ' + (mine ? 'me' : 'other');
    div.innerHTML = `${escape(m.text||'')}<small>${escape(m.fromName||'')}</small>`;
    return div;
  }

  async function pollChat(initial=false){
    if(!state.token) return;
    try{
      const q = new URLSearchParams();
      if(state.cursor) q.set('cursor', state.cursor);
      const r = await api(`/chat/messages?roomId=all&${q.toString()}`, {token:state.token});
      const msgs = r.messages || [];
      if (initial && !msgs.length && !state.cursor) {
        $('#chatThread').innerHTML = '<div class="muted">No messages yet.</div>';
      }
      if(msgs.length){
        const frag = document.createDocumentFragment();
        for(const m of msgs) frag.appendChild(renderMsg(m));
        const th = $('#chatThread');
        if (!state.cursor) th.innerHTML = ''; // first paint, clear
        th.appendChild(frag);
        th.scrollTop = th.scrollHeight + 999;
        state.cursor = r.cursor || msgs.at(-1)?.ts;
      }
    }catch(e){
      $('#chatMsg').textContent = 'Chat update failed';
    }
  }

  function startChat(){
    state.cursor = null;
    $('#chatThread').innerHTML = '<div class="muted">Loading…</div>';
    clearInterval(state.poll);
    pollChat(true);
    state.poll = setInterval(pollChat, 2500);
  }

  async function sendChat(){
    const text = $('#chatInput').value.trim();
    if(!text) return;
    try{
      await api('/chat/send', {method:'POST', token:state.token, body:{roomId:'all', text}});
      $('#chatInput').value = '';
      // optimistic paint
      const me = { text, fromName: state.member?.name || state.member?.email || 'Me', fromId: state.member?.id, role:'member' };
      $('#chatThread').appendChild(renderMsg(me));
      const th = $('#chatThread'); th.scrollTop = th.scrollHeight + 999;
    }catch(e){
      $('#chatMsg').textContent = e.message || 'Failed to send';
    }
  }

  function logout(){
    state.token = null; state.member=null; state.cursor=null; clearInterval(state.poll);
    setView();
  }

  $('#btnLogin').addEventListener('click', login);
  $('#password').addEventListener('keydown', (e)=>{ if(e.key==='Enter') login(); });
  $('#btnSend').addEventListener('click', sendChat);
  $('#chatInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); } });
  $('#btnLogout').addEventListener('click', logout);

  setView();
</script>
</body>
</html>

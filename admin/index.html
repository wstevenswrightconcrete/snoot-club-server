<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Snoot Club Admin</title>
  <style>
    :root{
      --sc-navy:#0D2139;
      --sc-silver:#B8BAB6;
      --sc-slate:#676F79;
      --sc-navy-dark:#081D35;
      --sc-navy-darker:#041932;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--sc-navy);
      color:var(--sc-silver);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    /* Header */
    .app-header{
      display:flex; align-items:center; gap:14px;
      padding:18px 20px;
      border-bottom:1px solid var(--sc-navy-dark);
      background:linear-gradient(180deg, var(--sc-navy) 0%, var(--sc-navy-dark) 100%);
      position:sticky; top:0; z-index:10;
    }
    .logo{
      height:44px; width:auto; display:block;
      filter: drop-shadow(0 1px 0 var(--sc-navy-darker));
      user-select:none;
    }
    .brand{
      line-height:1.1;
    }
    .brand-title{
      font-size: clamp(18px, 2.4vw, 22px);
      letter-spacing:.04em; font-weight:700;
      color:var(--sc-silver);
    }
    .brand-sub{
      font-size:12px; color:var(--sc-slate); letter-spacing:.12em;
    }

    /* Page shell */
    .wrap{max-width:980px; margin:28px auto; padding:0 20px}
    .card{
      background:rgba(4,25,50,.55);
      border:1px solid var(--sc-navy-dark);
      border-radius:var(--radius);
      box-shadow:0 12px 30px rgba(4,25,50,.45), inset 0 1px 0 rgba(184,186,182,.06);
      padding:20px;
    }
    h1{margin:.2em 0 .6em; font-size:26px; color:var(--sc-silver)}

    /* Buttons / inputs */
    .row{display:flex; gap:10px; flex-wrap:wrap}
    input,button,select{
      font:inherit;
      border-radius:12px;
      border:1px solid var(--sc-navy-dark);
      background:#0b1f34;
      color:var(--sc-silver);
      padding:10px 12px;
      outline:none;
    }
    input::placeholder{color:#7e8792}
    button{
      background:linear-gradient(180deg, #0f2742 0%, #0b1f34 100%);
      border:1px solid var(--sc-navy-dark);
      font-weight:600; letter-spacing:.02em; cursor:pointer;
    }
    button:hover{filter:brightness(1.07)}
    button:active{transform:translateY(1px)}
    .muted{color:var(--sc-slate)}

    /* Small helpers */
    .spacer{height:14px}
  </style>
</head>
<body>
  <header>
    <img id="brandLogo" src="/admin/logo.png" alt="Logo" />
    <h1>üîê Snoot Club Admin</h1>
    <span id="status" class="muted">locked</span>
    <span class="right"></span>
    <button id="btnLogout" class="hidden">Lock</button>
  </header>

  <main>
    <!-- Login -->
    <section id="loginCard" class="card">
      <div class="row">
        <label for="pin">Admin PIN</label>
        <input id="pin" type="password" inputmode="numeric" placeholder="Enter PIN" />
        <button id="btnUnlock">Unlock</button>
        <span id="loginMsg" class="muted"></span>
      </div>
      <p class="muted" style="margin-top:8px">PIN is checked by the server and never stored permanently (kept in memory only for this tab until you click ‚ÄúLock‚Äù).</p>
    </section>

    <!-- App -->
    <section id="app" class="grid2 hidden">
      <!-- Members -->
      <div class="card">
        <h3 style="margin-top:0">Members</h3>
        <div class="row">
          <button id="btnLoadPending">Load Pending</button>
          <button id="btnLoadAll">Load All</button>
          <span id="membersMsg" class="muted"></span>
        </div>
        <div id="membersList" class="list"></div>
      </div>

      <!-- Create meeting -->
      <div class="card">
        <h3 style="margin-top:0">Create Meeting</h3>
        <div class="row">
          <input id="mtTitle" placeholder="Title" class="grow" />
        </div>
        <div class="row">
          <input id="mtLocation" placeholder="Location" class="grow" />
        </div>
        <div class="row">
          <textarea id="mtDesc" placeholder="Description" rows="4" class="grow"></textarea>
        </div>
        <div class="row">
          <label>Starts</label>
          <input id="mtStart" type="datetime-local" />
          <label>Reminder (min)</label>
          <input id="mtRem" type="number" min="5" step="5" value="60" style="width:100px" />
        </div>
        <div class="row">
          <label class="row"><input type="checkbox" id="mtSms" checked />&nbsp;SMS on create</label>
          <label class="row"><input type="checkbox" id="mtPush" checked />&nbsp;Push on create</label>
          <button id="btnCreate">Create</button>
          <span id="createMsg" class="muted"></span>
        </div>
      </div>

      <!-- Meetings list (optional quick view) -->
      <div class="card" style="grid-column:1/-1">
        <div class="row">
          <h3 style="margin:0">Meetings</h3>
          <button id="btnLoadMeetings" class="right">Refresh</button>
        </div>
        <div id="meetingsList" class="list"></div>
      </div>
    </section>
  </main>

<script>
(() => {
  const API = location.origin;

  const els = {
    status:      document.getElementById('status'),
    loginCard:   document.getElementById('loginCard'),
    pin:         document.getElementById('pin'),
    btnUnlock:   document.getElementById('btnUnlock'),
    btnLogout:   document.getElementById('btnLogout'),
    loginMsg:    document.getElementById('loginMsg'),
    app:         document.getElementById('app'),
    btnLoadPending: document.getElementById('btnLoadPending'),
    btnLoadAll:  document.getElementById('btnLoadAll'),
    membersMsg:  document.getElementById('membersMsg'),
    membersList: document.getElementById('membersList'),
    mtTitle:     document.getElementById('mtTitle'),
    mtLocation:  document.getElementById('mtLocation'),
    mtDesc:      document.getElementById('mtDesc'),
    mtStart:     document.getElementById('mtStart'),
    mtRem:       document.getElementById('mtRem'),
    mtSms:       document.getElementById('mtSms'),
    mtPush:      document.getElementById('mtPush'),
    btnCreate:   document.getElementById('btnCreate'),
    createMsg:   document.getElementById('createMsg'),
    btnLoadMeetings: document.getElementById('btnLoadMeetings'),
    meetingsList: document.getElementById('meetingsList'),
  };

  const getPin = () => sessionStorage.getItem('adminPin') || '';
  const setPin = (pin) => pin ? sessionStorage.setItem('adminPin', pin) : sessionStorage.removeItem('adminPin');

  async function postJSON(path, body) {
    const r = await fetch(API + path, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body || {})
    });
    return r.json().catch(() => ({}));
  }

  async function adminFetch(method, path, body) {
    const pin = getPin();
    const r = await fetch(API + path + (method === 'GET' && body ? '?' + new URLSearchParams(body) : ''), {
      method,
      headers: { 'Content-Type': 'application/json', 'x-admin-pin': pin },
      body: method === 'GET' ? undefined : JSON.stringify(body || {})
    });
    const data = await r.json().catch(() => ({}));
    if (r.status === 401) throw new Error('unauthorized');
    return data;
  }

  function setLockedUI(locked) {
    els.status.textContent = locked ? 'locked' : 'unlocked';
    els.loginCard.classList.toggle('hidden', !locked);
    els.app.classList.toggle('hidden', locked);
    els.btnLogout.classList.toggle('hidden', locked);
    if (locked) { els.pin.value = ''; els.pin.focus(); }
  }

  async function tryUnlock(pin) {
    els.btnUnlock.disabled = true;
    els.pin.disabled = true;
    els.loginMsg.textContent = 'Checking‚Ä¶';
    try {
      const res = await postJSON('/auth/admin', { pin });
      if (res && res.ok === true) {
        setPin(pin);
        setLockedUI(false);
        els.loginMsg.textContent = '';
        await loadPending();
        await loadMeetings();
      } else {
        els.loginMsg.textContent = 'Wrong PIN';
        els.loginMsg.className = 'err';
      }
    } catch (e) {
      els.loginMsg.textContent = 'Network error';
      els.loginMsg.className = 'err';
    } finally {
      els.btnUnlock.disabled = false;
      els.pin.disabled = false;
    }
  }

  async function loadPending() {
    els.membersMsg.textContent = 'Loading pending‚Ä¶';
    try {
      const list = await adminFetch('GET', '/members', { status: 'pending' });
      renderMembers(list);
      els.membersMsg.textContent = `${list.length} pending`;
    } catch (e) {
      onUnauthorized(e);
    }
  }

  async function loadAll() {
    els.membersMsg.textContent = 'Loading all‚Ä¶';
    try {
      const list = await adminFetch('GET', '/members');
      renderMembers(list);
      els.membersMsg.textContent = `${list.length} total`;
    } catch (e) {
      onUnauthorized(e);
    }
  }

  function renderMembers(arr) {
    els.membersList.innerHTML = '';
    (arr || []).forEach(m => {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div class="grow">
          <div><strong>${escapeHtml(m.name || m.phone || 'Member')}</strong></div>
          <div class="muted">${m.phone || ''} ${m.email ? ' ¬∑ ' + m.email : ''}</div>
          <div class="pill">${m.status}${m.isAdmin ? ' ¬∑ admin' : ''}</div>
        </div>
        <div class="row">
          ${m.status !== 'approved' ? `<button data-act="approve">Approve</button>` : ''}
          ${m.status !== 'rejected' ? `<button data-act="reject">Reject</button>` : ''}
          ${!m.isAdmin ? `<button data-act="makeAdmin">Make Admin</button>` : `<button data-act="removeAdmin">Remove Admin</button>`}
          <button data-act="delete" style="border-color:#552">Delete</button>
        </div>
      `;
      div.addEventListener('click', async (ev) => {
        const b = ev.target.closest('button'); if (!b) return;
        const act = b.getAttribute('data-act');
        try {
          if (act === 'approve') await adminFetch('POST', `/members/${m.id}/approve`);
          if (act === 'reject') await adminFetch('POST', `/members/${m.id}/reject`);
          if (act === 'makeAdmin') await adminFetch('POST', `/members/${m.id}/make-admin`);
          if (act === 'removeAdmin') await adminFetch('POST', `/members/${m.id}/remove-admin`);
          if (act === 'delete') await adminFetch('DELETE', `/members/${m.id}`);
          await loadPending();
        } catch (e) { onUnauthorized(e); }
      });
      els.membersList.appendChild(div);
    });
  }

  async function createMeeting() {
    els.createMsg.textContent = 'Creating‚Ä¶';
    els.btnCreate.disabled = true;
    try {
      const startsAt = toIso(els.mtStart.value);
      const body = {
        title: els.mtTitle.value.trim(),
        description: els.mtDesc.value.trim(),
        location: els.mtLocation.value.trim(),
        startsAt,
        reminderMinutes: Number(els.mtRem.value || 60),
        sendSms: !!els.mtSms.checked,
        sendPush: !!els.mtPush.checked
      };
      const res = await adminFetch('POST', '/meetings', body);
      if (res && res.id) {
        els.createMsg.textContent = '‚úÖ Created';
        els.createMsg.className = 'ok';
        await loadMeetings();
      } else {
        els.createMsg.textContent = 'Failed';
        els.createMsg.className = 'err';
      }
    } catch (e) { onUnauthorized(e); }
    finally { els.btnCreate.disabled = false; }
  }

  async function loadMeetings() {
    // uses member-protected route; just show count for admin sanity via PIN header is not needed here
    try {
      // We can‚Äôt call /meetings without a member token; so just show nothing here.
      // (Keeping this section minimal. Admin can still create meetings above.)
      els.meetingsList.innerHTML = `<div class="muted">Note: /meetings is member-protected; this panel only confirms create status.</div>`;
    } catch {}
  }

  function onUnauthorized(e) {
    if (String(e && e.message) === 'unauthorized') {
      setPin('');
      setLockedUI(true);
      els.loginMsg.textContent = 'Session locked. Enter PIN again.';
      els.loginMsg.className = 'muted';
    }
  }

  // Utilities
  function toIso(local) {
    // local is "YYYY-MM-DDTHH:MM"
    if (!local) return '';
    const d = new Date(local);
    // preserve local value as-is; browsers may treat as local time
    return new Date(
      d.getFullYear(), d.getMonth(), d.getDate(),
      d.getHours(), d.getMinutes(), 0, 0
    ).toISOString();
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }

  // Wire up
  els.btnUnlock.addEventListener('click', () => {
    const pin = els.pin.value.trim();
    if (pin) tryUnlock(pin);
  });
  els.pin.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') els.btnUnlock.click();
  });
  els.btnLogout.addEventListener('click', () => {
    setPin('');
    setLockedUI(true);
  });
  els.btnLoadPending.addEventListener('click', loadPending);
  els.btnLoadAll.addEventListener('click', loadAll);
  els.btnCreate.addEventListener('click', createMeeting);
  els.btnLoadMeetings.addEventListener('click', loadMeetings);

  // Auto-try saved PIN (session only, not persistent)
  (async () => {
    const pin = getPin();
    if (pin) {
      try {
        const res = await postJSON('/auth/admin', { pin });
        if (res && res.ok) {
          setLockedUI(false);
          await loadPending();
          return;
        } else {
          setPin('');
        }
      } catch {}
    }
    setLockedUI(true);
  })();
})();
</script>
</body>
</html>

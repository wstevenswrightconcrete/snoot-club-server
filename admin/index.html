<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Snoot Club — Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1a33; --card:#112647; --text:#d9dfe8; --muted:#98a6b7; --accent:#58a6ff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .center{display:grid;place-items:center;min-height:100vh;padding:24px}
    .login{background:var(--card);border:1px solid #1c365f;border-radius:14px;padding:20px;max-width:420px;width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    input,textarea,select{flex:1;min-width:220px;background:#0e203f;border:1px solid #25426f;color:var(--text);border-radius:8px;padding:10px}
    button{background:var(--accent);color:#021a38;border:0;border-radius:8px;padding:10px 12px;cursor:pointer}
    .muted{color:var(--muted)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #203a66}
    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:16px}
    .card{background:var(--card);border:1px solid #1c365f;border-radius:14px;padding:14px}
    h1,h2{margin:0 0 8px 0}
    .list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto}
    .item{display:flex;gap:8px;justify-content:space-between;align-items:center;background:#0f2140;border:1px solid #203a66;border-radius:10px;padding:10px}
    .btn{background:#2f81f7;color:white;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.secondary{background:#223a66}
    .btn.warn{background:#d9534f}
    @media (max-width: 900px){ .wrap{grid-template-columns:1fr} }
  </style>
</head>
<body>

  <!-- Login gate (no storage, no auto-fill) -->
  <div id="gate" class="center">
    <div class="login">
      <h1>Admin Login</h1>
      <p class="muted">Enter the admin PIN to manage members and meetings. The PIN is not stored.</p>
      <div class="row">
        <input id="pin" type="password" placeholder="Admin PIN" autocomplete="off" />
      </div>
      <div class="row">
        <button id="enter">Enter</button>
        <span id="loginMsg" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- App (hidden until PIN validated) -->
  <div id="app" style="display:none">
    <header>
      <h1>Snoot Club — Admin</h1>
      <div class="row">
        <button id="lock" class="btn secondary">Lock</button>
        <span id="pinStatus" class="muted"></span>
      </div>
    </header>

    <div class="wrap">
      <section class="card">
        <h2>Members — Pending</h2>
        <div id="pending" class="list"></div>
      </section>

      <section class="card">
        <h2>Members — Approved</h2>
        <div id="approved" class="list"></div>
      </section>

      <section class="card">
        <h2>Create Meeting</h2>
        <div class="row">
          <input id="title" placeholder="Title" />
          <input id="location" placeholder="Location" />
        </div>
        <div class="row">
          <textarea id="description" placeholder="Description (optional)"></textarea>
        </div>
        <div class="row">
          <input id="date" type="date" />
          <input id="time" type="time" />
          <input id="rem" type="number" min="0" step="5" value="60" />
          <select id="notify">
            <option value="both">Notify: SMS + Push</option>
            <option value="sms">Notify: SMS only</option>
            <option value="push">Notify: Push only</option>
            <option value="none">Notify: none</option>
          </select>
        </div>
        <div class="row">
          <button class="btn" id="createBtn">Create Meeting</button>
          <span id="createMsg" class="muted"></span>
        </div>
      </section>

      <section class="card" style="grid-column:1 / -1">
        <h2>Meetings</h2>
        <div id="meetings" class="list"></div>
      </section>
    </div>
  </div>

  <script>
    const API = location.origin;
    let PIN = ''; // lives only in memory

    // UI elements
    const gate = document.getElementById('gate');
    const app = document.getElementById('app');
    const pinInput = document.getElementById('pin');
    const enterBtn = document.getElementById('enter');
    const lockBtn = document.getElementById('lock');
    const loginMsg = document.getElementById('loginMsg');
    const pinStatus = document.getElementById('pinStatus');

    const pendingEl = document.getElementById('pending');
    const approvedEl = document.getElementById('approved');
    const meetingsEl = document.getElementById('meetings');

    function headers() { return { 'content-type':'application/json', 'x-admin-pin': PIN }; }
    async function jget(path)  { const r = await fetch(API+path, { headers: headers() }); if(!r.ok) throw new Error(`GET ${path} ${r.status}`); return r.json(); }
    async function jpost(path, body) { const r = await fetch(API+path, { method:'POST', headers: headers(), body: JSON.stringify(body||{}) }); if(!r.ok) throw new Error(`POST ${path} ${r.status}`); return r.json(); }

    async function login() {
      loginMsg.textContent = '';
      const pin = (pinInput.value || '').trim();
      if (!pin) { loginMsg.textContent = 'PIN required.'; return; }
      try {
        const res = await fetch(API + '/auth/admin', {
          method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ pin })
        });
        const data = await res.json();
        if (data?.ok) {
          PIN = pin; // set in memory only
          gate.style.display = 'none';
          app.style.display = '';
          pinStatus.textContent = 'Admin active';
          await loadAll();
        } else {
          loginMsg.textContent = 'Invalid PIN.';
        }
      } catch (e) {
        loginMsg.textContent = 'Failed to check PIN.';
        console.error(e);
      }
    }

    enterBtn.addEventListener('click', login);
    pinInput.addEventListener('keyup', e => { if (e.key === 'Enter') login(); });
    lockBtn.addEventListener('click', () => {
      PIN = '';
      app.style.display = 'none';
      gate.style.display = '';
      pinInput.value = '';
      loginMsg.textContent = '';
      pinStatus.textContent = '';
    });

    async function loadMembers() {
      pendingEl.innerHTML = '<div class="muted">Loading…</div>';
      approvedEl.innerHTML = '<div class="muted">Loading…</div>';
      try {
        const list = await jget('/members');
        const pending = (list || []).filter(m => m.status === 'pending');
        const approved = (list || []).filter(m => m.status === 'approved');

        pendingEl.innerHTML = '';
        if (!pending.length) pendingEl.innerHTML = '<div class="muted">None pending</div>';
        pending.forEach(m => {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div>
              <div><strong>${m.name || 'Member'}</strong> · ${m.phone || ''}</div>
              <div class="muted">ID: ${m.id}</div>
            </div>
            <div class="row">
              <button class="btn" data-act="approve">Approve</button>
              <button class="btn secondary" data-act="reject">Reject</button>
            </div>`;
          div.querySelector('[data-act="approve"]').onclick = async () => { await jpost(\`/members/\${m.id}/approve\`); loadMembers(); };
          div.querySelector('[data-act="reject"]').onclick  = async () => { await jpost(\`/members/\${m.id}/reject\`);  loadMembers(); };
          pendingEl.appendChild(div);
        });

        approvedEl.innerHTML = '';
        if (!approved.length) approvedEl.innerHTML = '<div class="muted">No approved members yet</div>';
        approved.forEach(m => {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `
            <div>
              <div><strong>${m.name || 'Member'}</strong> ${m.isAdmin ? '· Admin' : ''} · ${m.phone || ''}</div>
              <div class="muted">ID: ${m.id}</div>
            </div>
            <div class="row">
              ${m.isAdmin
                ? '<button class="btn secondary" data-act="rmadmin">Remove Admin</button>'
                : '<button class="btn" data-act="mkadmin">Make Admin</button>'}
              <button class="btn warn" data-act="delete">Delete</button>
            </div>`;
          const mk = div.querySelector('[data-act="mkadmin"]');
          const rm = div.querySelector('[data-act="rmadmin"]');
          const del = div.querySelector('[data-act="delete"]');
          if (mk) mk.onclick = async () => { await jpost(\`/members/\${m.id}/make-admin\`); loadMembers(); };
          if (rm) rm.onclick = async () => { await jpost(\`/members/\${m.id}/remove-admin\`); loadMembers(); };
          if (del) del.onclick = async () => { await fetch(API + \`/members/\${m.id}\`, { method:'DELETE', headers: headers() }); loadMembers(); };
          approvedEl.appendChild(div);
        });
      } catch (e) {
        pendingEl.innerHTML = '<div class="muted">Failed to load (check PIN).</div>';
        approvedEl.innerHTML = '<div class="muted">Failed to load (check PIN).</div>';
        console.error(e);
      }
    }

    async function loadMeetings() {
      meetingsEl.innerHTML = '<div class="muted">Loading…</div>';
      try {
        // Server allows PIN OR Bearer via requireMemberOrAdmin
        const list = await jget('/meetings');
        meetingsEl.innerHTML = '';
        if (!list.length) meetingsEl.innerHTML = '<div class="muted">No meetings yet</div>';
        list.forEach(mt => {
          const div = document.createElement('div');
          const when = new Date(mt.startsAt).toLocaleString();
          div.className = 'item';
          div.innerHTML = `
            <div>
              <div><strong>${mt.title}</strong> · ${mt.location || 'TBA'}</div>
              <div class="muted">${when} · Reminder ${mt.reminderMinutes}m before</div>
              ${mt.description ? `<div class="muted">${mt.description}</div>` : ''}
            </div>`;
          meetingsEl.appendChild(div);
        });
      } catch (e) {
        meetingsEl.innerHTML = '<div class="muted">Failed to load meetings (check PIN).</div>';
        console.error(e);
      }
    }

    document.getElementById('createBtn').onclick = async () => {
      const title = document.getElementById('title').value.trim();
      const desc  = document.getElementById('description').value.trim();
      const loc   = document.getElementById('location').value.trim();
      const date  = document.getElementById('date').value;
      const time  = document.getElementById('time').value;
      const rem   = parseInt(document.getElementById('rem').value || '60', 10);
      const notify = document.getElementById('notify').value;
      const msg = document.getElementById('createMsg');

      msg.textContent = '';
      if (!title || !date || !time) { msg.textContent = 'Title, date, and time are required.'; return; }

      const startsAt = new Date(`${date}T${time}`).toISOString();
      const body = {
        title, description: desc, location: loc,
        startsAt, reminderMinutes: rem,
        sendSms: notify === 'both' || notify === 'sms',
        sendPush: notify === 'both' || notify === 'push'
      };

      try {
        await jpost('/meetings', body);
        msg.textContent = 'Meeting created!';
        await loadMeetings();
      } catch (e) {
        console.error(e);
        msg.textContent = 'Failed to create meeting (check PIN).';
      }
    };

    async function loadAll(){ await Promise.all([loadMembers(), loadMeetings()]); }
  </script>
</body>
</html>

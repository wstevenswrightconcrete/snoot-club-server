<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Snoot Club — Admin</title>
<style>
  :root { --navy:#0B1B32; --silver:#C0C0C0; }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--navy);color:var(--silver);margin:0}
  .wrap{max-width:880px;margin:32px auto;padding:0 16px}
  .card{background:#132A4B;border-radius:16px;padding:18px;margin-bottom:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  input,textarea,button{font:inherit}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #244;background:#0B1B32;color:var(--silver)}
  label{display:block;margin:10px 0 6px}
  button{background:var(--silver);color:var(--navy);border:0;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{opacity:.8}
  table{width:100%;border-collapse:collapse}
  td,th{border-bottom:1px solid #244;padding:8px}
  .switch{display:flex;gap:10px;align-items:center;margin:6px 0 12px}
  .flex{display:flex;gap:12px;flex-wrap:wrap}
  .right{margin-left:auto}
  .ok{color:#9ef59e}
  .err{color:#ff9b9b}
</style>
<div class="wrap">
  <h1>Snoot Club — Admin</h1>
  <p class="muted">Create meetings and notify everyone (SMS + Push).</p>

  <div class="card">
    <label>Render Base URL</label>
    <input id="base" placeholder="https://snoot-club-server.onrender.com" />
    <label>Admin PIN</label>
    <input id="pin" placeholder="*****" />
    <div class="flex" style="margin-top:10px">
      <button id="btnAuth">Unlock Admin</button>
      <span id="authState" class="muted">Locked</span>
    </div>
  </div>

  <div class="card" id="meetingCard" style="display:none">
    <h2 style="margin-top:0">New Meeting</h2>
    <label>Title</label><input id="title" />
    <label>Description (optional)</label><textarea id="desc" rows="3"></textarea>
    <div class="row">
      <div><label>Location</label><input id="loc" value="Lodge" /></div>
      <div><label>Starts At (your local time)</label><input id="dt" type="datetime-local" /></div>
    </div>
    <label>Reminder Minutes</label><input id="rem" type="number" value="60" />
    <div class="switch"><input type="checkbox" id="sms" checked /><label for="sms">Send SMS to members</label></div>
    <div class="switch"><input type="checkbox" id="push" checked /><label for="push">Send Push to devices</label></div>
    <div class="flex">
      <button id="btnCreate">Create & Notify</button>
      <span id="createState" class="muted"></span>
      <button id="btnLoad" class="right">Refresh Lists</button>
    </div>
  </div>

  <div class="card" id="listsCard" style="display:none">
    <div class="row">
      <div>
        <h3>Members (SMS)</h3>
        <table id="members"><thead><tr><th>Phone</th><th></th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h3>Meetings</h3>
        <table id="meetings"><thead><tr><th>Title</th><th>When</th><th>Location</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div id="out" class="muted"></div>
</div>

<script>
const $ = (id) => document.getElementById(id);
const show = (el, v=true)=>el.style.display = v ? '' : 'none';
const out = (msg, cls='') => { const el=$('out'); el.textContent=typeof msg==='string'?msg:JSON.stringify(msg,null,2); el.className=cls; };

let authed = false;
function base(){ return $('base').value.trim().replace(/\/+$/,''); }

async function api(path, method='GET', body){
  const url = base() + path;
  const opts = { method, headers:{ 'content-type':'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(url, opts);
  const text = await res.text();
  try { return JSON.parse(text); } catch { return text; }
}

$('btnAuth').onclick = async ()=>{
  try{
    const res = await api('/auth/admin','POST',{ pin:$('pin').value.trim() });
    if (res && res.ok){ authed=true; out('Admin unlocked', 'ok'); show($('meetingCard'), true); show($('listsCard'), true); loadLists(); }
    else { out('Wrong PIN', 'err'); }
  }catch(e){ out('Error: '+e.message, 'err'); }
};

$('btnCreate').onclick = async ()=>{
  if(!authed) return out('Unlock admin first','err');
  try{
    $('createState').textContent='Sending...';
    const local = $('dt').value; // yyyy-MM-ddTHH:mm (local)
    const iso = local ? new Date(local).toISOString() : new Date().toISOString();
    const payload = {
      title: $('title').value.trim(),
      description: $('desc').value.trim(),
      location: $('loc').value.trim(),
      startsAt: iso,
      reminderMinutes: parseInt($('rem').value || '60', 10),
      sendSms: $('sms').checked,
      sendPush: $('push').checked
    };
    const res = await api('/meetings','POST', payload);
    $('createState').textContent='Sent';
    out(res,'ok');
    loadLists();
  }catch(e){ $('createState').textContent='Error'; out('Error: '+e.message,'err'); }
};

$('btnLoad').onclick = ()=>loadLists();

async function loadLists(){
  try{
    const ms = await api('/meetings');
    const tbody = $('meetings').querySelector('tbody');
    tbody.innerHTML='';
    (ms||[]).forEach(m=>{
      const tr = document.createElement('tr');
      const when = new Date(m.startsAt).toLocaleString();
      tr.innerHTML = `<td>${m.title||''}</td><td>${when}</td><td>${m.location||''}</td>`;
      tbody.appendChild(tr);
    });

    const mems = await api('/members');
    const tbody2 = $('members').querySelector('tbody');
    tbody2.innerHTML='';
    (mems||[]).forEach(m=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${m.phone}</td><td><button data-id="${m.id}">Remove</button></td>`;
      tr.querySelector('button').onclick = async ()=>{
        await api('/members/'+m.id, 'DELETE');
        loadLists();
      };
      tbody2.appendChild(tr);
    });
  }catch(e){ out('Load error: '+e.message,'err'); }
}
</script>
